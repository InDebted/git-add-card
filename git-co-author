#!/usr/bin/env bash

set -euo pipefail

TRAILER_TOKEN="Co-authored-by"
USAGE="Easily add 'Co-authored-by' trailers to the commit template.

Usage:
  git co-author              Show co-author trailers
  git co-author initials...  Update co-author trailers
  git co-author --clear      Remove all co-author trailers
  git co-author --authors    List configured authors"

main() {
  show_trailers "$@"
  help_option "$@"
  clear_option "$@"
  authors_option "$@"
  update_trailers "$@"
}

show_trailers() {
  if [[ $# -eq 0 ]]
  then
    ensure_template_file
    print_trailers
    exit 0
  fi
}

help_option() {
  for arg in "$@"
  do
    if [[ $arg = "--help" ]] || [[ $arg = "-h" ]]
    then
      echo "$USAGE"
      exit 0
    fi
  done
}

clear_option() {
  for arg in "$@"
  do
    if [[ $arg = "--clear" ]]
    then
      ensure_template_file
      clear_trailers
      exit 0
    fi
  done
}

authors_option() {
  for arg in "$@"
  do
    if [[ $arg = "--authors" ]]
    then
      print_configured_authors
      exit 0
    fi
  done
}

update_trailers() {
  ensure_template_file
  must_have_initials "$@"
  clear_trailers
  add_trailers "$@"
  print_trailers
  exit 0
}

abort() {
  >&2 echo "$1"
  exit 1
}

ensure_template_file() {
  must_have_config "commit.template" "commit template is not configured

Example:
  git config --global commit.template '~/.git-commit-template'"

  template_file=$(git config commit.template)
  template_file="${template_file/#\~/$HOME}"  # Replace '~' with $HOME

  touch "$template_file"
}

must_have_config() {
  local key=$1
  local error=$2
  if ! git config "$key" &> /dev/null
  then
    abort "$error"
  fi

  if [[ -z $(git config "$key") ]]
  then
    abort "$error"
  fi
}

must_have_initials() {
  for initials in "$@"
  do
      must_have_config "co-authors.$initials" "co-author '$initials' is not configured

Example:
  git config --global co-authors.aa 'Ann Author <ann.author@example.com>'"
  done
}

add_trailers() {
  for initials in "$@"
  do
    value=$(git config "co-authors.$initials")
    git interpret-trailers --trailer "$TRAILER_TOKEN: $value" --in-place "$template_file"
  done
}

clear_trailers() {
  local temp_file
  temp_file=$(mktemp)
  sed "/$TRAILER_TOKEN/d" "$template_file" > "$temp_file"
  mv "$temp_file" "$template_file"
}

print_trailers() {
  sed -n "/$TRAILER_TOKEN/p" "$template_file"
}

print_configured_authors() {
  if ! git config --get-regexp "co-authors.*" &> /dev/null
  then
    echo "No authors in config.

Example:
  git config --global co-authors.aa 'Ann Author <ann.author@example.com>'"
  else
    git config --get-regexp 'co-authors.*' |
      sed -E "s/co-authors.([a-z0-9-]+)[[:space:]](.*)/\1|'\2'/" |
      column -t -s"|" |
      sort
  fi
}

main "$@"
